name: docker

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 0 * * *' # 每天早上0点

env:
  # Use docker.io for Docker Hub if empty
  REGISTRY: ghcr.io

jobs:
  mirror:
    name: Mirror ${{ matrix.image }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: ["traefik:v3.0.2", "portainer/portainer-ce:2.16.2-alpine", "gitea/gitea:1.17.3", "drone/drone:2.16.0", "filebrowser/filebrowser:v2.23.0", "nginx:1.23.3-alpine"]
    permissions:
      contents: read
      packages: write
      # This is used to complete the identity challenge
      # with sigstore/fulcio when running outside of PRs.
      id-token: write

    steps:
      # Set up BuildKit Docker container builder to be able to build
      # multi-platform images and export cache
      # https://github.com/docker/setup-buildx-action
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

      # Login against a Docker registry except on PR
      # https://github.com/docker/login-action
      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Mirror
      - name: Mirror ${{ matrix.image }} to ${{ env.REGISTRY }}/${{ github.actor }}/${{ matrix.image }}
        run: |
          # docker login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} ${{ env.REGISTRY }}
          for arch in arm64 amd64
          do
            docker pull --platform $arch ${{ matrix.image }}
            docker tag ${{ matrix.image }} ${{ env.REGISTRY }}/${{ github.actor }}/${{ matrix.image }}
            docker push ${{ env.REGISTRY }}/${{ github.actor }}/${{ matrix.image }}
            docker rmi ${{ env.REGISTRY }}/${{ github.actor }}/${{ matrix.image }}
            docker rmi ${{ matrix.image }}
          done
