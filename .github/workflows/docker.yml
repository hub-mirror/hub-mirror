name: docker

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 0 * * *' # 每天早上0点

env:
  # Use docker.io for Docker Hub if empty
  REGISTRY: ghcr.io

jobs:
  mirror:
    name: Mirror ${{ matrix.image }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: 
          - "traefik:v3.0.2"
          - "portainer/portainer-ce:2.16.2"
          - "portainer/portainer-ce:2.16.2-alpine"
          - "gitea/gitea:1.17.3"
          - "drone/drone:2.16.0"
          - "drone/drone:2.24.0"
          - "harness/gitness:3.0.0-beta.7"
          - "filebrowser/filebrowser:v2.23.0"
          - "nginx:1.23.3"
          - "nginx:1.23.3-alpine"
          - "redis:7.0.4"
          - "redis:7.0.4-alpine"
    permissions:
      contents: read
      packages: write
      # This is used to complete the identity challenge
      # with sigstore/fulcio when running outside of PRs.
      id-token: write

    steps:
      # Set up BuildKit Docker container builder to be able to build
      # multi-platform images and export cache
      # https://github.com/docker/setup-buildx-action
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

      # Login against a Docker registry except on PR
      # https://github.com/docker/login-action
      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Mirror
      - name: Mirror ${{ matrix.image }} to ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.image }}
        run: |
          # docker login -u ${{ github.repository_owner }} -p ${{ secrets.GITHUB_TOKEN }} ${{ env.REGISTRY }}
          image="${{ matrix.image }}"
          image_mirror="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.image }}"
          platforms=($(docker manifest inspect $image | jq -r '.manifests[] | .platform.architecture'))
          platform_manifests=()
          for platform in "${platforms[@]}"; do
            docker pull --platform $platform $image
            docker tag $image $image_mirror-$platform
            docker push $image_mirror-$platform
            platform_manifests+=("$image_mirror-$platform")
          done
          docker manifest create $image_mirror ${platform_manifests[@]}
          docker manifest push $image_mirror
